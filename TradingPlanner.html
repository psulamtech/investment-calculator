<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Swing Trade Planner</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #080c14;
    --surface: #0d1421;
    --surface2: #111d30;
    --border: #1e2d45;
    --accent: #00d4aa;
    --accent2: #00a8ff;
    --red: #ff4d6a;
    --gold: #f5c842;
    --text: #e2eaf4;
    --muted: #5a7a9a;
    --input-bg: #0a1828;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Mono', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    background-image:
      radial-gradient(ellipse 80% 50% at 50% -10%, rgba(0,212,170,0.07) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 80% 80%, rgba(0,168,255,0.05) 0%, transparent 50%);
  }

  /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  header {
    border-bottom: 1px solid var(--border);
    padding: 28px 48px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(8,12,20,0.9);
    backdrop-filter: blur(10px);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .logo {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 1.25rem;
    letter-spacing: -0.02em;
    color: var(--accent);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .logo-dot {
    width: 8px; height: 8px;
    background: var(--accent);
    border-radius: 50%;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.4; transform: scale(0.8); }
  }

  .header-badge {
    font-size: 0.7rem;
    color: var(--muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  /* â”€â”€ Main Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  main {
    max-width: 1200px;
    margin: 0 auto;
    padding: 48px 24px 80px;
  }

  .hero {
    text-align: center;
    margin-bottom: 56px;
    animation: fadeUp 0.8s ease both;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(20px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .hero h1 {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: clamp(2rem, 5vw, 3.2rem);
    letter-spacing: -0.03em;
    line-height: 1.1;
    margin-bottom: 12px;
  }

  .hero h1 span { color: var(--accent); }

  .hero p {
    color: var(--muted);
    font-size: 0.9rem;
    letter-spacing: 0.05em;
  }

  /* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 32px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 4px;
    width: fit-content;
  }

  .tab {
    padding: 10px 24px;
    border-radius: 8px;
    border: none;
    background: transparent;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.05em;
  }

  .tab.active {
    background: var(--accent);
    color: var(--bg);
    font-weight: 500;
  }

  .tab:hover:not(.active) { color: var(--text); }

  .panel { display: none; }
  .panel.active { display: block; animation: fadeUp 0.4s ease both; }

  /* â”€â”€ Cards & Sections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }

  .grid-3 {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 20px;
  }

  @media (max-width: 768px) {
    .grid-2, .grid-3 { grid-template-columns: 1fr; }
    header { padding: 20px 24px; }
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.3s;
  }

  .card:hover { border-color: rgba(0,212,170,0.3); }

  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    opacity: 0;
    transition: opacity 0.3s;
  }

  .card:hover::before { opacity: 1; }

  .card-title {
    font-family: 'Syne', sans-serif;
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .card-title::before {
    content: '';
    display: block;
    width: 16px; height: 2px;
    background: var(--accent);
  }

  /* â”€â”€ Form Elements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .field { margin-bottom: 16px; }

  label {
    display: block;
    font-size: 0.72rem;
    color: var(--muted);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  input[type="number"], input[type="text"], select {
    width: 100%;
    background: var(--input-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 16px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 0.95rem;
    transition: border-color 0.2s, box-shadow 0.2s;
    outline: none;
    -moz-appearance: textfield;
  }

  input::-webkit-outer-spin-button,
  input::-webkit-inner-spin-button { -webkit-appearance: none; }

  input:focus, select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(0,212,170,0.12);
  }

  select option { background: var(--surface2); }

  /* â”€â”€ Result Boxes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .result-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-top: 4px;
  }

  .result-box {
    background: var(--input-bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
    transition: border-color 0.3s;
  }

  .result-box.highlight {
    border-color: rgba(0,212,170,0.4);
    background: rgba(0,212,170,0.04);
  }

  .result-box .r-label {
    font-size: 0.65rem;
    color: var(--muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 6px;
  }

  .result-box .r-value {
    font-family: 'Syne', sans-serif;
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--accent);
  }

  .result-box .r-value.red { color: var(--red); }
  .result-box .r-value.gold { color: var(--gold); }
  .result-box .r-value.blue { color: var(--accent2); }

  /* â”€â”€ Trade Quality Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .quality-banner {
    border-radius: 12px;
    padding: 18px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 20px;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 1rem;
    transition: all 0.4s;
  }

  .quality-banner.valid {
    background: rgba(0,212,170,0.1);
    border: 1px solid rgba(0,212,170,0.4);
    color: var(--accent);
  }

  .quality-banner.invalid {
    background: rgba(255,77,106,0.08);
    border: 1px solid rgba(255,77,106,0.3);
    color: var(--red);
  }

  .quality-banner.neutral {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--muted);
  }

  /* â”€â”€ Checklist â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .checklist { list-style: none; }

  .checklist li {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
    font-size: 0.85rem;
    color: #8aa0ba;
    cursor: pointer;
    transition: color 0.2s;
    user-select: none;
  }

  .checklist li:last-child { border-bottom: none; }
  .checklist li:hover { color: var(--text); }

  .check-box {
    width: 20px; height: 20px;
    border: 1.5px solid var(--border);
    border-radius: 5px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    font-size: 0.75rem;
  }

  .checklist li.checked .check-box {
    background: var(--accent);
    border-color: var(--accent);
    color: var(--bg);
  }

  .checklist li.checked { color: var(--text); text-decoration: line-through; }

  /* â”€â”€ Journal Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .table-wrap {
    overflow-x: auto;
    border-radius: 12px;
    border: 1px solid var(--border);
  }

  table {
    width: 100%;
    min-width: 1500px;
    border-collapse: collapse;
    font-size: 0.82rem;
  }

  thead tr {
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
  }

  th {
    padding: 14px 12px;
    text-align: left;
    font-size: 0.65rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--muted);
    font-weight: 500;
    white-space: nowrap;
  }

  tbody tr {
    border-bottom: 1px solid rgba(30,45,69,0.6);
    transition: background 0.15s;
  }

  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: rgba(0,212,170,0.03); }

  td { padding: 10px 12px; vertical-align: middle; }

  /* Fixed column widths so inputs have room to breathe */
  #journalTable th:nth-child(1), #journalTable td:nth-child(1) { width: 45px; }   /* # */
  #journalTable th:nth-child(2), #journalTable td:nth-child(2) { width: 155px; }  /* Date */
  #journalTable th:nth-child(3), #journalTable td:nth-child(3) { width: 110px; }  /* Ticker */
  #journalTable th:nth-child(4), #journalTable td:nth-child(4) { width: 120px; }  /* Entry */
  #journalTable th:nth-child(5), #journalTable td:nth-child(5) { width: 120px; }  /* Target */
  #journalTable th:nth-child(6), #journalTable td:nth-child(6) { width: 120px; }  /* Stop */
  #journalTable th:nth-child(7), #journalTable td:nth-child(7) { width: 110px; }  /* Shares */
  #journalTable th:nth-child(8), #journalTable td:nth-child(8) { width: 120px; }  /* Risk */
  #journalTable th:nth-child(9), #journalTable td:nth-child(9) { width: 120px; }  /* Target P&L */
  #journalTable th:nth-child(10), #journalTable td:nth-child(10) { width: 120px; } /* Exit */
  #journalTable th:nth-child(11), #journalTable td:nth-child(11) { width: 120px; } /* Actual P&L */
  #journalTable th:nth-child(12), #journalTable td:nth-child(12) { width: 110px; } /* Status */
  #journalTable th:nth-child(13), #journalTable td:nth-child(13) { width: 130px; } /* Balance */
  #journalTable th:nth-child(14), #journalTable td:nth-child(14) { width: 60px; }  /* Actions */

  td input {
    background: var(--input-bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 0.9rem;
    width: 100%;
    min-width: 90px;
    outline: none;
    padding: 9px 12px;
    transition: border-color 0.2s, box-shadow 0.2s;
    box-sizing: border-box;
  }

  td input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(0,212,170,0.12);
  }

  .badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 0.7rem;
    font-weight: 500;
  }

  .badge.win { background: rgba(0,212,170,0.15); color: var(--accent); }
  .badge.loss { background: rgba(255,77,106,0.15); color: var(--red); }
  .badge.open { background: rgba(245,200,66,0.15); color: var(--gold); }

  .btn {
    padding: 8px 18px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 0.78rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn:hover { border-color: var(--accent); color: var(--accent); }

  .btn-primary {
    background: var(--accent);
    border-color: var(--accent);
    color: var(--bg);
    font-weight: 500;
  }

  .btn-primary:hover { background: #00bfa0; color: var(--bg); }

  .btn-danger { border-color: rgba(255,77,106,0.3); color: var(--red); }
  .btn-danger:hover { background: rgba(255,77,106,0.1); }

  /* â”€â”€ Stats Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 22px;
    text-align: center;
    transition: all 0.3s;
  }

  .stat-card:hover { transform: translateY(-2px); border-color: rgba(0,212,170,0.3); }

  .stat-val {
    font-family: 'Syne', sans-serif;
    font-size: 1.8rem;
    font-weight: 800;
    margin-bottom: 4px;
  }

  .stat-lbl {
    font-size: 0.68rem;
    color: var(--muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  /* â”€â”€ Progress Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .milestone-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px 24px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 20px;
    transition: border-color 0.3s;
  }

  .milestone-item.reached {
    border-color: rgba(0,212,170,0.5);
    background: rgba(0,212,170,0.04);
  }

  .milestone-label {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 1rem;
    min-width: 90px;
  }

  .prog-wrap {
    flex: 1;
    background: var(--surface2);
    border-radius: 99px;
    height: 6px;
    overflow: hidden;
  }

  .prog-fill {
    height: 100%;
    border-radius: 99px;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    transition: width 0.8s cubic-bezier(0.4,0,0.2,1);
  }

  .milestone-status {
    font-size: 0.78rem;
    color: var(--muted);
    min-width: 80px;
    text-align: right;
  }

  .milestone-item.reached .milestone-status { color: var(--accent); font-weight: 500; }

  /* â”€â”€ Divider â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .section-gap { margin-bottom: 24px; }

  .full-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    margin-bottom: 20px;
  }

  .table-actions {
    display: flex;
    gap: 10px;
    margin-bottom: 16px;
    align-items: center;
    justify-content: space-between;
  }

  .section-header {
    font-family: 'Syne', sans-serif;
    font-size: 1.1rem;
    font-weight: 700;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .section-header span { font-size: 0.7rem; color: var(--muted); font-weight: 400; letter-spacing: 0.1em; text-transform: uppercase; }

  .empty-state {
    text-align: center;
    padding: 40px;
    color: var(--muted);
    font-size: 0.85rem;
  }

  /* â”€â”€ Tooltip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .tip {
    display: inline-block;
    width: 16px; height: 16px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 50%;
    color: var(--muted);
    font-size: 0.6rem;
    text-align: center;
    line-height: 14px;
    cursor: default;
    margin-left: 4px;
    vertical-align: middle;
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .tag {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.65rem;
    background: rgba(0,212,170,0.1);
    color: var(--accent);
    letter-spacing: 0.08em;
    margin-left: 8px;
  }

</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-dot"></div>
    TRADE<span style="color:var(--text)">PLANNER</span>
  </div>
  <div class="header-badge">3:1 Risk/Reward System Â· Swing Trading</div>
  <div id="syncStatus" style="font-size:0.72rem;color:var(--muted);font-family:'DM Mono',monospace;">â³ Connecting to Google Sheets...</div>
</header>

<main>


  <div class="tabs">
    <button class="tab active" onclick="switchTab('planner', this)">ğŸ“Š Trade Planner</button>
    <button class="tab" onclick="switchTab('journal', this)">ğŸ“’ Journal</button>
    <button class="tab" onclick="switchTab('performance', this)">ğŸ“ˆ Performance</button>
    <button class="tab" onclick="switchTab('average', this)">ğŸ§® Avg Calculator</button>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PLANNER PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="panel-planner" class="panel active">
    <div class="grid-2">

      <!-- Account Settings -->
      <div class="card">
        <div class="card-title">Account Settings</div>
        <div class="field">
          <label>Account Balance ($)</label>
          <input type="number" id="accountBalance" value="10000" oninput="calc()">
        </div>
        <div class="field">
          <label>Max Risk Per Trade (%)</label>
          <input type="number" id="riskPct" value="2" step="0.1" min="0.1" max="5" oninput="calc()">
        </div>
        <div class="field">
          <label>Max Portfolio Heat (%)</label>
          <input type="number" id="heatPct" value="6" step="0.5" oninput="calc()">
        </div>
        <div class="result-grid" style="margin-top:8px;">
          <div class="result-box highlight">
            <div class="r-label">Max Risk ($)</div>
            <div class="r-value" id="maxRiskDollar">$200</div>
          </div>
          <div class="result-box highlight">
            <div class="r-label">Max Portfolio at Risk</div>
            <div class="r-value blue" id="maxHeatDollar">$600</div>
          </div>
        </div>
      </div>

      <!-- Trade Entry -->
      <div class="card">
        <div class="card-title">Trade Entry <span class="tag">FILL IN BELOW</span></div>
        <div class="grid-2" style="gap:12px;margin-bottom:0;">
          <div class="field">
            <label>Stock Ticker</label>
            <input type="text" id="ticker" placeholder="AAPL" style="text-transform:uppercase" oninput="calc()">
          </div>
          <div class="field">
            <label>Conviction</label>
            <select id="conviction" onchange="calc()">
              <option value="1">ğŸŸ¡ Low (5%)</option>
              <option value="2" selected>ğŸŸ¢ Medium (10%)</option>
              <option value="3">ğŸ”¥ High (15%)</option>
              <option value="4">ğŸš€ Max (20%)</option>
            </select>
          </div>
        </div>
        <div class="field">
          <label>Entry Price ($)</label>
          <input type="number" id="entryPrice" value="100" step="0.01" oninput="calc()">
        </div>
        <div class="field">
          <label>Stop Loss % (below entry)</label>
          <input type="number" id="stopPct" value="5" step="0.5" oninput="calc()">
        </div>
      </div>
    </div>

    <!-- Calculated Results -->
    <div class="card section-gap">
      <div class="card-title">Calculated Trade Parameters</div>
      <div class="result-grid" style="grid-template-columns:repeat(4,1fr);">
        <div class="result-box">
          <div class="r-label">Profit Target %</div>
          <div class="r-value" id="r-profitPct">15.0%</div>
        </div>
        <div class="result-box">
          <div class="r-label">Stop Loss Price</div>
          <div class="r-value red" id="r-stopPrice">$95.00</div>
        </div>
        <div class="result-box">
          <div class="r-label">Target Price</div>
          <div class="r-value" id="r-targetPrice">$115.00</div>
        </div>
        <div class="result-box">
          <div class="r-label">Position Size</div>
          <div class="r-value blue" id="r-shares">40 shares</div>
        </div>
        <div class="result-box">
          <div class="r-label">Total Position Value</div>
          <div class="r-value" id="r-posValue">$4,000</div>
        </div>
        <div class="result-box highlight">
          <div class="r-label">Max $ at Risk</div>
          <div class="r-value red" id="r-riskDollar">$200</div>
        </div>
        <div class="result-box highlight">
          <div class="r-label">Expected Profit ($)</div>
          <div class="r-value" id="r-profit">$600</div>
        </div>
        <div class="result-box">
          <div class="r-label">Account Return</div>
          <div class="r-value gold" id="r-accountReturn">6.0%</div>
        </div>
      </div>

      <div class="quality-banner neutral" id="qualityBanner">
        Enter your trade details above to check trade quality
      </div>
    </div>

    <!-- Pre-Trade Checklist -->
    <div class="card">
      <div class="card-title">Pre-Trade Checklist</div>
      <ul class="checklist" id="checklist">
        <li onclick="toggleCheck(this)"><div class="check-box">âœ“</div>Entry price, stop loss & profit target defined BEFORE buying</li>
        <li onclick="toggleCheck(this)"><div class="check-box">âœ“</div>Risk/Reward is at least 3:1</li>
        <li onclick="toggleCheck(this)"><div class="check-box">âœ“</div>Position size calculated â€” max 2% of account at risk</li>
        <li onclick="toggleCheck(this)"><div class="check-box">âœ“</div>Limit SELL order placed at target immediately after buying</li>
        <li onclick="toggleCheck(this)"><div class="check-box">âœ“</div>Stop loss order placed immediately after buying</li>
        <li onclick="toggleCheck(this)"><div class="check-box">âœ“</div>Total portfolio heat still under 6â€“8%</li>
        <li onclick="toggleCheck(this)"><div class="check-box">âœ“</div>This is a high-conviction setup â€” NOT a FOMO trade</li>
        <li onclick="toggleCheck(this)"><div class="check-box">âœ“</div>I will NOT move my profit target higher after entering</li>
      </ul>
      <div style="display:flex;gap:8px;margin-top:16px;">
        <button class="btn" onclick="checkAll()">Check All</button>
        <button class="btn" onclick="uncheckAll()">Reset</button>
        <button class="btn btn-primary" onclick="logTrade()">â• Log This Trade to Journal</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• JOURNAL PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="panel-journal" class="panel">
    <div class="full-card">
      <div class="table-actions">
        <div class="section-header">Trade Journal <span>all your trades</span></div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-primary" onclick="addRow()">+ Add Trade</button>
          <button class="btn" onclick="loadFromSheets()">ğŸ”„ Sync</button>
          <button class="btn btn-danger" onclick="clearJournal()">Clear All</button>
        </div>
      </div>
      <div class="table-wrap">
        <table id="journalTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Date</th>
              <th>Ticker</th>
              <th>Entry $</th>
              <th>Target $</th>
              <th>Stop $</th>
              <th>Shares</th>
              <th>Risk $</th>
              <th>Target P&L</th>
              <th>Exit $</th>
              <th>Actual P&L</th>
              <th>Status</th>
              <th>Balance</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="journalBody">
          </tbody>
        </table>
        <div id="journalEmpty" class="empty-state">No trades logged yet. Use the Trade Planner to log your first trade!</div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PERFORMANCE PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="panel-performance" class="panel">

    <!-- Stats Grid -->
    <div class="grid-3" id="statsGrid">
      <div class="stat-card">
        <div class="stat-val" id="s-winRate" style="color:var(--accent)">â€”</div>
        <div class="stat-lbl">Win Rate</div>
      </div>
      <div class="stat-card">
        <div class="stat-val" id="s-totalPL" style="color:var(--accent)">â€”</div>
        <div class="stat-lbl">Total P&L</div>
      </div>
      <div class="stat-card">
        <div class="stat-val" id="s-totalReturn" style="color:var(--gold)">â€”</div>
        <div class="stat-lbl">Account Return</div>
      </div>
      <div class="stat-card">
        <div class="stat-val" id="s-trades" style="color:var(--accent2)">0</div>
        <div class="stat-lbl">Total Trades</div>
      </div>
      <div class="stat-card">
        <div class="stat-val" id="s-avgWin" style="color:var(--accent)">â€”</div>
        <div class="stat-lbl">Avg Win ($)</div>
      </div>
      <div class="stat-card">
        <div class="stat-val" id="s-avgLoss" style="color:var(--red)">â€”</div>
        <div class="stat-lbl">Avg Loss ($)</div>
      </div>
      <div class="stat-card">
        <div class="stat-val" id="s-rr" style="color:var(--gold)">â€”</div>
        <div class="stat-lbl">Actual R/R Ratio</div>
      </div>
      <div class="stat-card">
        <div class="stat-val" id="s-best" style="color:var(--accent)">â€”</div>
        <div class="stat-lbl">Best Trade</div>
      </div>
      <div class="stat-card">
        <div class="stat-val" id="s-worst" style="color:var(--red)">â€”</div>
        <div class="stat-lbl">Worst Trade</div>
      </div>
    </div>

    <!-- Milestones -->
    <div class="full-card">
      <div class="section-header">Compounding Milestones <span>3:1 RR @ 60% win rate</span></div>
      <div id="milestones"></div>
      <div style="display:flex;align-items:center;gap:12px;margin-top:20px;padding-top:20px;border-top:1px solid var(--border);">
        <label style="text-transform:none;font-size:0.85rem;color:var(--muted);margin:0;">Starting Balance:</label>
        <input type="number" id="startBalance" style="width:160px;padding:8px 12px;" value="10000" oninput="updatePerformance()">
        <span style="font-size:0.8rem;color:var(--muted);">Current: <strong id="currentBalance" style="color:var(--accent)">$10,000</strong></span>
      </div>
    </div>

    <!-- Rules Reminder -->
    <div class="full-card">
      <div class="section-header">The System Rules <span>memorize these</span></div>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;">
        <div style="background:var(--input-bg);border-radius:10px;padding:20px;border:1px solid var(--border);">
          <div style="color:var(--accent);font-size:0.7rem;letter-spacing:0.1em;text-transform:uppercase;margin-bottom:10px;font-weight:700;">âœ… Always Do This</div>
          <ul style="list-style:none;font-size:0.83rem;color:#8aa0ba;line-height:2;">
            <li>â†’ Set target at 3x your stop loss</li>
            <li>â†’ Size position to risk max 2% of account</li>
            <li>â†’ Place limit orders IMMEDIATELY after entry</li>
            <li>â†’ Walk away â€” let orders execute</li>
            <li>â†’ Keep total heat under 6â€“8%</li>
          </ul>
        </div>
        <div style="background:var(--input-bg);border-radius:10px;padding:20px;border:1px solid var(--border);">
          <div style="color:var(--red);font-size:0.7rem;letter-spacing:0.1em;text-transform:uppercase;margin-bottom:10px;font-weight:700;">âŒ Never Do This</div>
          <ul style="list-style:none;font-size:0.83rem;color:#8aa0ba;line-height:2;">
            <li>â†’ Move profit target higher after entry</li>
            <li>â†’ Hold through your stop loss "hoping"</li>
            <li>â†’ Trade on FOMO or emotion</li>
            <li>â†’ Increase size after a loss (revenge trade)</li>
            <li>â†’ Let a big winner turn into a loser</li>
          </ul>
        </div>
      </div>
    </div>

  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AVERAGE CALCULATOR PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="panel-average" class="panel">

    <!-- Mode Toggle -->
    <div style="display:flex;gap:12px;margin-bottom:24px;align-items:center;">
      <button id="modeDown" class="btn btn-primary" onclick="setMode('down')" style="padding:12px 28px;font-size:0.85rem;">ğŸ“‰ Average Down</button>
      <button id="modeUp"   class="btn"             onclick="setMode('up')"   style="padding:12px 28px;font-size:0.85rem;">ğŸ“ˆ Average Up</button>
      <span id="modeDesc" style="font-size:0.78rem;color:var(--muted);margin-left:8px;">Buy more as price drops to lower your cost basis</span>
    </div>

    <div class="grid-2">

      <!-- Existing Position -->
      <div class="card">
        <div class="card-title">Your Current Position</div>
        <div class="field">
          <label>Stock Ticker (optional)</label>
          <input type="text" id="avg-ticker" placeholder="AAPL" style="text-transform:uppercase">
        </div>
        <div class="field">
          <label>Original Buy Price ($)</label>
          <input type="number" id="avg-origPrice" placeholder="100.00" step="0.01" oninput="calcAvg()">
        </div>
        <div class="field">
          <label>Number of Shares Owned</label>
          <input type="number" id="avg-origShares" placeholder="100" oninput="calcAvg()">
        </div>
        <div class="field">
          <label id="avg-newPriceLabel">New Buy Price ($) <span style="color:var(--red);font-size:0.7rem;">â†“ lower than original</span></label>
          <input type="number" id="avg-newPrice" placeholder="85.00" step="0.01" oninput="calcAvg()">
        </div>
        <div class="field">
          <label>Additional Shares to Buy</label>
          <input type="number" id="avg-newShares" placeholder="50" oninput="calcAvg()">
        </div>
      </div>

      <!-- Results -->
      <div class="card">
        <div class="card-title">Calculated Results</div>
        <div class="result-grid" style="grid-template-columns:1fr 1fr;">
          <div class="result-box highlight">
            <div class="r-label">New Avg Cost Basis</div>
            <div class="r-value" id="avg-newAvg">â€”</div>
          </div>
          <div class="result-box">
            <div class="r-label">Original Cost Basis</div>
            <div class="r-value" style="color:var(--muted)" id="avg-origAvg">â€”</div>
          </div>
          <div class="result-box">
            <div class="r-label">Cost Basis Change</div>
            <div class="r-value" id="avg-change">â€”</div>
          </div>
          <div class="result-box">
            <div class="r-label">Total Shares</div>
            <div class="r-value blue" id="avg-totalShares">â€”</div>
          </div>
          <div class="result-box">
            <div class="r-label">Total Invested ($)</div>
            <div class="r-value" id="avg-totalInvested">â€”</div>
          </div>
          <div class="result-box">
            <div class="r-label">Additional Capital Needed</div>
            <div class="r-value gold" id="avg-extraCapital">â€”</div>
          </div>
        </div>

        <!-- Break Even -->
        <div style="background:var(--input-bg);border:1px solid var(--border);border-radius:10px;padding:16px;margin-top:16px;">
          <div style="font-size:0.68rem;color:var(--muted);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:10px;">Break-Even Analysis</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div>
              <div style="font-size:0.7rem;color:var(--muted);margin-bottom:4px;">Break-Even Price</div>
              <div style="font-family:'Syne',sans-serif;font-size:1.2rem;font-weight:700;color:var(--gold)" id="avg-breakeven">â€”</div>
            </div>
            <div>
              <div style="font-size:0.7rem;color:var(--muted);margin-bottom:4px;">% Move Needed to Break Even</div>
              <div style="font-family:'Syne',sans-serif;font-size:1.2rem;font-weight:700;" id="avg-breakevenPct">â€”</div>
            </div>
            <div>
              <div style="font-size:0.7rem;color:var(--muted);margin-bottom:4px;">P&L at Current New Price</div>
              <div style="font-family:'Syne',sans-serif;font-size:1.2rem;font-weight:700;" id="avg-plNow">â€”</div>
            </div>
            <div>
              <div style="font-size:0.7rem;color:var(--muted);margin-bottom:4px;">P&L at Original Buy Price</div>
              <div style="font-family:'Syne',sans-serif;font-size:1.2rem;font-weight:700;" id="avg-plOrig">â€”</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Multi-Buy Ladder -->
    <div class="full-card" style="margin-top:4px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
        <div class="section-header" style="margin-bottom:0;">Buy Ladder <span id="ladderModeLabel">â€” add up to 5 buys to see blended average</span></div>
        <button class="btn btn-primary" onclick="addLadderRow()">+ Add Buy</button>
      </div>

      <div class="table-wrap">
        <table id="ladderTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Buy Price ($)</th>
              <th>Shares</th>
              <th>Total Cost ($)</th>
              <th>% of Position</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="ladderBody"></tbody>
        </table>
      </div>

      <!-- Ladder Summary -->
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:20px;" id="ladderSummary">
        <div class="result-box highlight">
          <div class="r-label">Blended Avg Price</div>
          <div class="r-value" id="l-avgPrice">â€”</div>
        </div>
        <div class="result-box">
          <div class="r-label">Total Shares</div>
          <div class="r-value blue" id="l-totalShares">â€”</div>
        </div>
        <div class="result-box">
          <div class="r-label">Total Invested</div>
          <div class="r-value" id="l-totalCost">â€”</div>
        </div>
        <div class="result-box">
          <div class="r-label">Break-Even Price</div>
          <div class="r-value gold" id="l-breakeven">â€”</div>
        </div>
      </div>

      <!-- Warning box -->
      <div id="avg-warning" style="display:none;margin-top:16px;background:rgba(255,77,106,0.08);border:1px solid rgba(255,77,106,0.3);border-radius:10px;padding:16px;font-size:0.83rem;color:var(--red);"></div>
    </div>

    <!-- Tips -->
    <div class="full-card" style="margin-top:4px;">
      <div class="section-header">âš ï¸ Golden Rules for Averaging</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;" id="avgTips">
        <div style="background:var(--input-bg);border-radius:10px;padding:20px;border:1px solid var(--border);">
          <div style="color:var(--red);font-size:0.7rem;letter-spacing:0.1em;text-transform:uppercase;margin-bottom:10px;font-weight:700;">ğŸ“‰ Averaging Down Rules</div>
          <ul style="list-style:none;font-size:0.83rem;color:#8aa0ba;line-height:2.2;">
            <li>â†’ Only average down if the thesis is still valid</li>
            <li>â†’ Never average down just because it's cheaper</li>
            <li>â†’ Max 1â€“2 additional buys â€” don't keep adding</li>
            <li>â†’ New buy must still have 3:1 risk/reward</li>
            <li>â†’ If it hits your original stop loss â€” EXIT, don't average</li>
          </ul>
        </div>
        <div style="background:var(--input-bg);border-radius:10px;padding:20px;border:1px solid var(--border);">
          <div style="color:var(--accent);font-size:0.7rem;letter-spacing:0.1em;text-transform:uppercase;margin-bottom:10px;font-weight:700;">ğŸ“ˆ Averaging Up Rules</div>
          <ul style="list-style:none;font-size:0.83rem;color:#8aa0ba;line-height:2.2;">
            <li>â†’ Only add to a position that is already profitable</li>
            <li>â†’ Add on breakouts or pullbacks to support</li>
            <li>â†’ Keep additional buy smaller than original (pyramid up)</li>
            <li>â†’ Raise your stop loss on the full position after adding</li>
            <li>â†’ Don't chase â€” only add if momentum confirms</li>
          </ul>
        </div>
      </div>
    </div>

  </div>

</main>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SHEET_URL = 'https://script.google.com/macros/s/AKfycbw21ipFikUeFZVrKkdT1TuafEk1723L4kNhYxBvBbgj9FPpR8KgDHxtHW21MFpZRaQZwA/exec';

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let trades = [];
let isSyncing = false;

function setSyncStatus(msg, color='var(--muted)') {
  const el = document.getElementById('syncStatus');
  if (el) { el.textContent = msg; el.style.color = color; }
}

function loadFromSheets() {
  setSyncStatus('â³ Loading from Google Sheets...', 'var(--gold)');
  fetch(SHEET_URL + '?t=' + Date.now())
    .then(r => r.json())
    .then(data => {
      trades = (Array.isArray(data) ? data : []).filter(r => r.id).map(r => ({
        id:     String(r.id),
        date:   r.date   || '',
        ticker: r.ticker || '',
        entry:  r.entry  || '',
        target: r.target || '',
        stop:   r.stop   || '',
        shares: r.shares || '',
        exit:   r.exit   || '',
        notes:  r.notes  || ''
      }));
      localStorage.setItem('stp_trades', JSON.stringify(trades));
      setSyncStatus('âœ… Synced with Google Sheets', 'var(--accent)');
      renderJournal();
      updatePerformance();
    })
    .catch(() => fallbackToLocal());
}

function fallbackToLocal() {
  setSyncStatus('âš ï¸ Using local backup â€” check your Sheets connection', 'var(--gold)');
  trades = JSON.parse(localStorage.getItem('stp_trades') || '[]');
  renderJournal();
  updatePerformance();
}

async function saveToSheets() {
  if (isSyncing) return;
  isSyncing = true;
  setSyncStatus('ğŸ’¾ Saving...', 'var(--gold)');
  localStorage.setItem('stp_trades', JSON.stringify(trades));
  try {
    const res = await fetch(SHEET_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action: 'save', trades }),
    });
    setSyncStatus('âœ… Saved Â· ' + new Date().toLocaleTimeString(), 'var(--accent)');
  } catch(e) {
    setSyncStatus('âš ï¸ Saved locally only â€” Sheets sync failed', 'var(--gold)');
  }
  isSyncing = false;
}

// â”€â”€ Tab Switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name, btn) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  btn.classList.add('active');
  if (name === 'journal') renderJournal();
  if (name === 'performance') updatePerformance();
}

// â”€â”€ Formatting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(n, decimals=2) {
  if (isNaN(n) || n === null) return 'â€”';
  return new Intl.NumberFormat('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(n);
}

function fmtCurrency(n) {
  if (isNaN(n) || n === null) return 'â€”';
  const abs = Math.abs(n);
  const str = '$' + fmt(abs);
  return n < 0 ? '-' + str : str;
}

function fmtPct(n) {
  if (isNaN(n) || n === null) return 'â€”';
  return fmt(n, 1) + '%';
}

// â”€â”€ Planner Calc â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calc() {
  const bal        = parseFloat(document.getElementById('accountBalance').value) || 0;
  const riskP      = parseFloat(document.getElementById('riskPct').value) / 100 || 0;
  const heatP      = parseFloat(document.getElementById('heatPct').value) / 100 || 0;
  const entry      = parseFloat(document.getElementById('entryPrice').value) || 0;
  const stopP      = parseFloat(document.getElementById('stopPct').value) / 100 || 0;
  const conviction = parseInt(document.getElementById('conviction').value) || 2;

  // Conviction â†’ max capital allocation % of account
  const allocPct   = conviction === 1 ? 0.05 : conviction === 2 ? 0.10 : conviction === 3 ? 0.15 : 0.20;
  const maxAlloc   = bal * allocPct;  // max $ to put in this trade

  const maxRisk    = bal * riskP;
  const maxHeat    = bal * heatP;
  const profitP    = stopP * 3;
  const stopPrice  = entry * (1 - stopP);
  const targetPrice= entry * (1 + profitP);

  // Position size = LOWER of: (max risk / stop distance) OR (max allocation / entry)
  // This means conviction caps how many shares even if risk allows more
  const sharesByRisk  = entry > 0 && stopP > 0 ? Math.floor(maxRisk / (entry * stopP)) : 0;
  const sharesByAlloc = entry > 0 ? Math.floor(maxAlloc / entry) : 0;
  const shares        = Math.min(sharesByRisk, sharesByAlloc);

  const posVal       = shares * entry;
  const riskDollar   = shares * (entry - stopPrice);
  const profitDollar = shares * (targetPrice - entry);
  const accReturn    = bal > 0 ? (profitDollar / bal * 100) : 0;

  document.getElementById('maxRiskDollar').textContent = '$' + fmt(maxRisk);
  document.getElementById('maxHeatDollar').textContent = '$' + fmt(maxHeat);
  document.getElementById('r-profitPct').textContent   = fmtPct(profitP * 100);
  document.getElementById('r-stopPrice').textContent   = '$' + fmt(stopPrice);
  document.getElementById('r-targetPrice').textContent = '$' + fmt(targetPrice);
  document.getElementById('r-shares').textContent      = shares + ' shares';
  document.getElementById('r-posValue').textContent    = '$' + fmt(posVal) + ' (' + (allocPct*100) + '% of acct)';
  document.getElementById('r-riskDollar').textContent  = '$' + fmt(riskDollar);
  document.getElementById('r-profit').textContent      = '$' + fmt(profitDollar);
  document.getElementById('r-accountReturn').textContent = fmtPct(accReturn);

  const rr = riskDollar > 0 ? profitDollar / riskDollar : 0;
  const convLabel = conviction === 1 ? 'ğŸŸ¡ Low' : conviction === 2 ? 'ğŸŸ¢ Medium' : conviction === 3 ? 'ğŸ”¥ High' : 'ğŸš€ Max';
  const banner = document.getElementById('qualityBanner');
  if (entry === 0) {
    banner.className = 'quality-banner neutral';
    banner.innerHTML = 'Enter your trade details above to check trade quality';
  } else if (Math.round(rr * 10) >= 30) {
    banner.className = 'quality-banner valid';
    banner.innerHTML = `âœ… VALID TRADE  â€”  R/R: ${fmt(rr,1)}x  Â·  Conviction: ${convLabel}  Â·  Allocating ${(allocPct*100)}% ($${fmt(posVal)})  Â·  Risk $${fmt(riskDollar)}  â†’  Reward $${fmt(profitDollar)}`;
  } else {
    banner.className = 'quality-banner invalid';
    banner.innerHTML = `âŒ SKIP THIS TRADE  â€”  R/R only ${fmt(rr,1)}x. Need at least 3:1. Widen target or tighten stop.`;
  }
}

// â”€â”€ Checklist â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleCheck(el) { el.classList.toggle('checked'); }
function checkAll() { document.querySelectorAll('#checklist li').forEach(li => li.classList.add('checked')); }
function uncheckAll() { document.querySelectorAll('#checklist li').forEach(li => li.classList.remove('checked')); }

// â”€â”€ Log Trade â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function logTrade() {
  const ticker  = (document.getElementById('ticker').value || 'N/A').toUpperCase();
  const entry   = parseFloat(document.getElementById('entryPrice').value) || 0;
  const stopP   = parseFloat(document.getElementById('stopPct').value) / 100 || 0;
  const profitP = stopP * 3;
  const bal     = parseFloat(document.getElementById('accountBalance').value) || 0;
  const riskP   = parseFloat(document.getElementById('riskPct').value) / 100 || 0;
  const maxRisk = bal * riskP;
  const shares  = entry > 0 && stopP > 0 ? Math.floor(maxRisk / (entry * stopP)) : 0;

  if (!entry || !shares) { alert('Please fill in your entry price first.'); return; }

  const trade = {
    id: Date.now(),
    date: new Date().toLocaleDateString(),
    ticker,
    entry: entry.toFixed(2),
    target: (entry * (1 + profitP)).toFixed(2),
    stop: (entry * (1 - stopP)).toFixed(2),
    shares,
    exit: '',
    notes: ''
  };

  trades.push(trade);
  save();
  alert(`âœ… Trade logged & saved to Google Sheets: ${ticker} Â· ${shares} shares @ $${entry}`);
}

// â”€â”€ Journal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function save() { saveToSheets(); }

function addRow() {
  trades.push({
    id: Date.now(),
    date: new Date().toLocaleDateString(),
    ticker: '',
    entry: '',
    target: '',
    stop: '',
    shares: '',
    exit: '',
    notes: ''
  });
  save();
  renderJournal();
}

function deleteRow(id) {
  if (!confirm('Delete this trade?')) return;
  trades = trades.filter(t => String(t.id) !== String(id));
  save();
  renderJournal();
  updatePerformance();
}

let saveTimer = null;
function debouncedSave() {
  clearTimeout(saveTimer);
  saveTimer = setTimeout(() => saveToSheets(), 1500);
  localStorage.setItem('stp_trades', JSON.stringify(trades));
}

function updateField(id, field, val) {
  const t = trades.find(t => String(t.id) === String(id));
  if (t) {
    t[field] = val;
    updateRowCalcs(id);   // only update calculated cells in this row
    updatePerformance();
    debouncedSave();      // save after 1.5s of no typing â€” no re-render
  }
}

function updateRowCalcs(id) {
  // Recalculate just the formula cells for one row without rebuilding table
  const t = trades.find(t => String(t.id) === String(id));
  if (!t) return;
  const entry  = parseFloat(t.entry)  || 0;
  const stop   = parseFloat(t.stop)   || 0;
  const target = parseFloat(t.target) || 0;
  const shares = parseFloat(t.shares) || 0;
  const exit   = parseFloat(t.exit)   || 0;
  const rowEl  = document.querySelector(`tr[data-id="${id}"]`);
  if (!rowEl) return;

  const riskDollar  = shares * (entry - stop);
  const targetPL    = shares * (target - entry);
  const actualPL    = exit ? shares * (exit - entry) : null;

  rowEl.querySelector('.cell-risk').textContent    = entry && shares ? fmtCurrency(riskDollar) : 'â€”';
  rowEl.querySelector('.cell-targetpl').textContent= entry && shares ? fmtCurrency(targetPL)   : 'â€”';
  rowEl.querySelector('.cell-actualpl').textContent= actualPL !== null ? fmtCurrency(actualPL) : 'â€”';
  rowEl.querySelector('.cell-actualpl').style.color= actualPL === null ? 'var(--muted)' : actualPL >= 0 ? 'var(--accent)' : 'var(--red)';

  const badge = rowEl.querySelector('.cell-status');
  if (actualPL !== null) {
    badge.innerHTML = actualPL >= 0
      ? '<span class="badge win">âœ… WIN</span>'
      : '<span class="badge loss">âŒ LOSS</span>';
  } else {
    badge.innerHTML = '<span class="badge open">Open</span>';
  }

  // Recalc running balances for all rows
  refreshBalances();
}

function refreshBalances() {
  let bal = parseFloat(document.getElementById('startBalance')?.value || 10000);
  trades.forEach(t => {
    const exit = parseFloat(t.exit) || 0;
    const entry = parseFloat(t.entry) || 0;
    const shares = parseFloat(t.shares) || 0;
    const actualPL = exit ? shares * (exit - entry) : null;
    if (actualPL !== null) bal += actualPL;
    const rowEl = document.querySelector(`tr[data-id="${t.id}"]`);
    if (rowEl) {
      const balCell = rowEl.querySelector('.cell-balance');
      if (balCell) balCell.textContent = exit ? fmtCurrency(bal) : 'â€”';
    }
  });
}

function clearJournal() {
  if (confirm('Clear all trades? This cannot be undone.')) {
    trades = [];
    save();
    renderJournal();
    updatePerformance();
  }
}

function renderJournal() {
  const tbody = document.getElementById('journalBody');
  const empty = document.getElementById('journalEmpty');
  tbody.innerHTML = '';

  if (trades.length === 0) {
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  let runningBal = parseFloat(document.getElementById('startBalance')?.value || 10000);

  trades.forEach((t, i) => {
    const entry  = parseFloat(t.entry)  || 0;
    const shares = parseFloat(t.shares) || 0;
    const stopV  = parseFloat(t.stop)   || 0;
    const tgt    = parseFloat(t.target) || 0;
    const exit   = parseFloat(t.exit)   || 0;

    const riskDollar   = shares * (entry - stopV);
    const targetPL     = shares * (tgt - entry);
    const actualPL     = exit ? shares * (exit - entry) : null;

    if (actualPL !== null) runningBal += actualPL;

    let statusBadge = '<span class="badge open">Open</span>';
    if (actualPL !== null) {
      statusBadge = actualPL >= 0
        ? '<span class="badge win">âœ… WIN</span>'
        : '<span class="badge loss">âŒ LOSS</span>';
    }

    const plColor = actualPL === null ? 'var(--muted)' : actualPL >= 0 ? 'var(--accent)' : 'var(--red)';

    const tr = document.createElement('tr');
    tr.setAttribute('data-id', t.id);
    tr.innerHTML = `
      <td style="color:var(--muted);font-size:0.75rem;">${i+1}</td>
      <td><input value="${t.date}"   oninput="updateField('${t.id}','date',this.value)"   placeholder="mm/dd/yy"></td>
      <td><input value="${t.ticker}" oninput="updateField('${t.id}','ticker',this.value.toUpperCase());this.value=this.value.toUpperCase()" placeholder="AAPL" style="text-transform:uppercase"></td>
      <td><input type="number" value="${t.entry}"  oninput="updateField('${t.id}','entry',this.value)"  placeholder="0.00"></td>
      <td><input type="number" value="${t.target}" oninput="updateField('${t.id}','target',this.value)" placeholder="0.00"></td>
      <td><input type="number" value="${t.stop}"   oninput="updateField('${t.id}','stop',this.value)"   placeholder="0.00"></td>
      <td><input type="number" value="${t.shares}" oninput="updateField('${t.id}','shares',this.value)" placeholder="0"></td>
      <td class="cell-risk"     style="color:var(--red);">${entry && shares ? fmtCurrency(riskDollar) : 'â€”'}</td>
      <td class="cell-targetpl" style="color:var(--accent);">${entry && shares ? fmtCurrency(targetPL) : 'â€”'}</td>
      <td><input type="number" value="${t.exit}" oninput="updateField('${t.id}','exit',this.value)" placeholder="Exit price"></td>
      <td class="cell-actualpl" style="color:${plColor};font-weight:600;">${actualPL !== null ? fmtCurrency(actualPL) : 'â€”'}</td>
      <td class="cell-status">${statusBadge}</td>
      <td class="cell-balance" style="color:var(--accent);font-weight:600;">${exit ? fmtCurrency(runningBal) : 'â€”'}</td>
      <td><button class="btn btn-danger" style="padding:4px 10px;font-size:0.72rem;" onclick="deleteRow('${t.id}')">âœ•</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// â”€â”€ Performance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updatePerformance() {
  const startBal = parseFloat(document.getElementById('startBalance')?.value || 10000);

  const closed = trades.filter(t => t.exit && parseFloat(t.entry) && parseFloat(t.shares));
  const pls = closed.map(t => parseFloat(t.shares) * (parseFloat(t.exit) - parseFloat(t.entry)));
  const wins = pls.filter(p => p > 0);
  const losses = pls.filter(p => p < 0);

  const totalPL = pls.reduce((a,b) => a+b, 0);
  const currentBal = startBal + totalPL;
  const winRate = closed.length ? (wins.length / closed.length * 100) : null;
  const avgWin = wins.length ? wins.reduce((a,b)=>a+b,0)/wins.length : null;
  const avgLoss = losses.length ? losses.reduce((a,b)=>a+b,0)/losses.length : null;
  const rr = avgLoss ? Math.abs(avgWin / avgLoss) : null;
  const best = pls.length ? Math.max(...pls) : null;
  const worst = pls.length ? Math.min(...pls) : null;
  const totalReturn = startBal ? totalPL / startBal * 100 : 0;

  const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };

  set('s-winRate', winRate !== null ? fmtPct(winRate) : 'â€”');
  set('s-totalPL', pls.length ? fmtCurrency(totalPL) : 'â€”');
  set('s-totalReturn', pls.length ? fmtPct(totalReturn) : 'â€”');
  set('s-trades', closed.length);
  set('s-avgWin', avgWin !== null ? fmtCurrency(avgWin) : 'â€”');
  set('s-avgLoss', avgLoss !== null ? fmtCurrency(avgLoss) : 'â€”');
  set('s-rr', rr !== null ? fmt(rr,1) + 'x' : 'â€”');
  set('s-best', best !== null ? fmtCurrency(best) : 'â€”');
  set('s-worst', worst !== null ? fmtCurrency(worst) : 'â€”');

  const curBalEl = document.getElementById('currentBalance');
  if (curBalEl) curBalEl.textContent = fmtCurrency(currentBal);

  // Color P&L
  const plEl = document.getElementById('s-totalPL');
  if (plEl) plEl.style.color = totalPL >= 0 ? 'var(--accent)' : 'var(--red)';
  const retEl = document.getElementById('s-totalReturn');
  if (retEl) retEl.style.color = totalReturn >= 0 ? 'var(--gold)' : 'var(--red)';

  // Milestones
  const targets = [
    { label: '2Ã— Account',  mult: 2  },
    { label: '3Ã— Account',  mult: 3  },
    { label: '5Ã— Account',  mult: 5  },
    { label: '10Ã— Account', mult: 10 },
  ];

  const mDiv = document.getElementById('milestones');
  mDiv.innerHTML = '';
  targets.forEach(t => {
    const targetBal = startBal * t.mult;
    const progress = Math.min((currentBal - startBal) / (targetBal - startBal) * 100, 100);
    const reached = currentBal >= targetBal;
    const item = document.createElement('div');
    item.className = 'milestone-item' + (reached ? ' reached' : '');
    item.innerHTML = `
      <div class="milestone-label" style="color:${reached ? 'var(--accent)' : 'var(--text)'}">${t.label}</div>
      <div style="flex:1;">
        <div class="prog-wrap"><div class="prog-fill" style="width:${Math.max(progress,0)}%"></div></div>
        <div style="font-size:0.7rem;color:var(--muted);margin-top:4px;">${fmtCurrency(currentBal)} / ${fmtCurrency(targetBal)}</div>
      </div>
      <div class="milestone-status">${reached ? 'âœ… HIT!' : Math.round(Math.max(progress,0)) + '%'}</div>
    `;
    mDiv.appendChild(item);
  });
}


// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
calc();
loadFromSheets();

// â”€â”€ Average Calculator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let avgMode = 'down';
let ladderRows = [
  { id: 1, price: '', shares: '' },
  { id: 2, price: '', shares: '' }
];

renderLadder();

function setMode(mode) {
  avgMode = mode;
  document.getElementById('modeDown').className = mode === 'down' ? 'btn btn-primary' : 'btn';
  document.getElementById('modeUp').className   = mode === 'up'   ? 'btn btn-primary' : 'btn';
  document.getElementById('modeDesc').textContent = mode === 'down'
    ? 'Buy more as price drops to lower your cost basis'
    : 'Add to a winning position as price moves in your favor';
  const lbl = document.getElementById('avg-newPriceLabel');
  lbl.innerHTML = mode === 'down'
    ? 'New Buy Price ($) <span style="color:var(--red);font-size:0.7rem;">â†“ lower than original</span>'
    : 'New Buy Price ($) <span style="color:var(--accent);font-size:0.7rem;">â†‘ higher than original</span>';
  document.getElementById('ladderModeLabel').textContent = mode === 'down'
    ? 'â€” add multiple dip buys to see blended cost basis'
    : 'â€” add multiple adds to see blended average up price';
  calcAvg();
  renderLadder();
}

function calcAvg() {
  const origPrice  = parseFloat(document.getElementById('avg-origPrice').value);
  const origShares = parseFloat(document.getElementById('avg-origShares').value);
  const newPrice   = parseFloat(document.getElementById('avg-newPrice').value);
  const newShares  = parseFloat(document.getElementById('avg-newShares').value);
  const warn = document.getElementById('avg-warning');

  if (!origPrice || !origShares || !newPrice || !newShares) {
    ['avg-newAvg','avg-origAvg','avg-change','avg-totalShares','avg-totalInvested',
     'avg-extraCapital','avg-breakeven','avg-breakevenPct','avg-plNow','avg-plOrig']
      .forEach(id => { const el = document.getElementById(id); if(el) el.textContent = 'â€”'; });
    warn.style.display = 'none';
    return;
  }

  const totalShares   = origShares + newShares;
  const totalInvested = (origPrice * origShares) + (newPrice * newShares);
  const newAvg        = totalInvested / totalShares;
  const change        = newAvg - origPrice;
  const extraCapital  = newPrice * newShares;
  const breakevenPct  = ((newAvg - newPrice) / newPrice) * 100;
  const plNow         = (newPrice - newAvg) * totalShares;
  const plOrig        = (origPrice - newAvg) * totalShares;

  document.getElementById('avg-newAvg').textContent        = '$' + fmt(newAvg);
  document.getElementById('avg-origAvg').textContent       = '$' + fmt(origPrice);
  document.getElementById('avg-change').textContent        = (change >= 0 ? '+' : '-') + '$' + fmt(Math.abs(change));
  document.getElementById('avg-change').style.color        = change <= 0 ? 'var(--accent)' : 'var(--red)';
  document.getElementById('avg-totalShares').textContent   = fmt(totalShares, 0) + ' shares';
  document.getElementById('avg-totalInvested').textContent = '$' + fmt(totalInvested);
  document.getElementById('avg-extraCapital').textContent  = '$' + fmt(extraCapital);
  document.getElementById('avg-breakeven').textContent     = '$' + fmt(newAvg);
  document.getElementById('avg-breakevenPct').textContent  = (breakevenPct >= 0 ? '+' : '') + fmt(breakevenPct, 1) + '%';
  document.getElementById('avg-breakevenPct').style.color  = breakevenPct <= 0 ? 'var(--accent)' : 'var(--red)';
  document.getElementById('avg-plNow').textContent         = fmtCurrency(plNow);
  document.getElementById('avg-plNow').style.color         = plNow >= 0 ? 'var(--accent)' : 'var(--red)';
  document.getElementById('avg-plOrig').textContent        = fmtCurrency(plOrig);
  document.getElementById('avg-plOrig').style.color        = plOrig >= 0 ? 'var(--accent)' : 'var(--red)';

  warn.style.display = 'none';
  if (avgMode === 'down' && newPrice >= origPrice) {
    warn.style.display = 'block';
    warn.textContent = 'âš ï¸ Warning: Your new buy price is higher than or equal to your original. For averaging DOWN, the new price should be lower.';
  } else if (avgMode === 'up' && newPrice <= origPrice) {
    warn.style.display = 'block';
    warn.textContent = 'âš ï¸ Warning: Your new buy price is lower than or equal to your original. For averaging UP, the new price should be higher.';
  } else if (avgMode === 'down' && newShares > origShares * 2) {
    warn.style.display = 'block';
    warn.textContent = 'âš ï¸ Caution: Adding more than 2Ã— your original size is aggressive â€” make sure your thesis is very strong.';
  }
}

function addLadderRow() {
  if (ladderRows.length >= 8) return;
  ladderRows.push({ id: Date.now(), price: '', shares: '' });
  renderLadder();
}

function deleteLadderRow(id) {
  if (ladderRows.length <= 2) return;
  ladderRows = ladderRows.filter(r => r.id !== id);
  renderLadder();
}

function updateLadder(id, field, val) {
  const r = ladderRows.find(r => r.id === id);
  if (r) { r[field] = val; calcLadder(); }
}

function renderLadder() {
  const tbody = document.getElementById('ladderBody');
  tbody.innerHTML = '';
  ladderRows.forEach((row, i) => {
    const price  = parseFloat(row.price)  || 0;
    const shares = parseFloat(row.shares) || 0;
    const cost   = price && shares ? price * shares : null;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="color:var(--muted);font-size:0.75rem;">Buy ${i+1}</td>
      <td><input type="number" value="${row.price}" placeholder="0.00" oninput="updateLadder(${row.id},'price',this.value)"></td>
      <td><input type="number" value="${row.shares}" placeholder="0" oninput="updateLadder(${row.id},'shares',this.value)"></td>
      <td style="color:var(--text);">${cost ? '$'+fmt(cost) : 'â€”'}</td>
      <td id="l-pct-${row.id}" style="color:var(--muted);">â€”</td>
      <td><button class="btn btn-danger" style="padding:4px 10px;font-size:0.72rem;" onclick="deleteLadderRow(${row.id})" ${ladderRows.length<=2?'disabled':''}>âœ•</button></td>
    `;
    tbody.appendChild(tr);
  });
  calcLadder();
}

function calcLadder() {
  const valid = ladderRows.filter(r => parseFloat(r.price) && parseFloat(r.shares));
  if (valid.length < 1) {
    ['l-avgPrice','l-totalShares','l-totalCost','l-breakeven'].forEach(id => {
      const el = document.getElementById(id); if(el) el.textContent = 'â€”';
    });
    return;
  }
  const totalCost   = valid.reduce((s,r) => s + parseFloat(r.price)*parseFloat(r.shares), 0);
  const totalShares = valid.reduce((s,r) => s + parseFloat(r.shares), 0);
  const avgPrice    = totalCost / totalShares;

  document.getElementById('l-avgPrice').textContent    = '$' + fmt(avgPrice);
  document.getElementById('l-totalShares').textContent = fmt(totalShares, 0) + ' shares';
  document.getElementById('l-totalCost').textContent   = '$' + fmt(totalCost);
  document.getElementById('l-breakeven').textContent   = '$' + fmt(avgPrice);

  ladderRows.forEach(row => {
    const s = parseFloat(row.shares) || 0;
    const el = document.getElementById('l-pct-' + row.id);
    if (el) el.textContent = totalShares > 0 && s > 0 ? fmt(s/totalShares*100,1)+'%' : 'â€”';
  });
}

renderLadder();
</script>
</body>
</html>
